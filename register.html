<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - NoDealer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f8f8; }
        .container { max-width: 450px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #002f34; margin-bottom: 30px; font-size: 24px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-size: 14px; font-weight: 500; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; }
        input:focus { outline: none; border-color: #002f34; }
        button { width: 100%; padding: 14px; background: #002f34; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #003d47; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .otp-section { display: none; border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px; }
        .otp-group { display: flex; gap: 10px; align-items: flex-end; }
        .otp-group input { flex: 1; }
        .otp-group button { flex: 0 0 120px; padding: 12px; margin-top: 0; font-size: 14px; }
        .error { color: red; font-size: 14px; margin: 10px 0; background: #ffe6e6; padding: 10px; border-radius: 4px; }
        .success { color: green; font-size: 14px; margin: 10px 0; background: #e6ffe6; padding: 10px; border-radius: 4px; }
        .info { color: #0066cc; font-size: 13px; margin: 10px 0; background: #e6f3ff; padding: 10px; border-radius: 4px; }
        .link { text-align: center; margin-top: 20px; }
        .link a { color: #002f34; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Create Account - NoDealer</h1>
        
        <div id="step1">
            <div class="form-group">
                <label for="fullName">Full Name *</label>
                <input type="text" id="fullName" placeholder="Enter your full name" required>
            </div>
            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input type="tel" id="phone" placeholder="Enter your phone number" required>
            </div>
            <div class="form-group">
                <label for="password">Password (min 6 chars) *</label>
                <input type="password" id="password" placeholder="Create a strong password" required>
            </div>
            <button id="sendOtpBtn" onclick="sendOTP()">Send OTP to Email</button>
        </div>

        <div id="step2" class="otp-section">
            <div class="info" id="otpInfo">OTP has been sent to your email.</div>
            <div class="form-group">
                <label for="emailOtp">Enter Email OTP *</label>
                <div class="otp-group">
                    <input type="text" id="emailOtp" placeholder="Enter 6-digit OTP" maxlength="6">
                    <button onclick="resendOTP()" id="resendBtn">Resend OTP</button>
                </div>
            </div>
            <button id="verifyBtn" onclick="verifyAndRegister()">Verify & Register</button>
        </div>

        <div id="message"></div>
        
        <div class="link">
            <a href="login.html">Already have an account? Login</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vycimtexfyzlmlywjrzd.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5Y2ltdGV4Znl6bG1seXdqcnpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4NDA5NTUsImV4cCI6MjA1MzQxNjk1NX0.qzW1U3Z8vKb1dBL4PHG_hGxwt8mKzL5tUOjl7ygDLJU'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        let generatedOTP = ''
        let userData = {}

        async function sendOTP() {
            const message = document.getElementById('message')
            message.innerHTML = ''

            const fullName = document.getElementById('fullName').value.trim()
            const email = document.getElementById('email').value.trim()
            const phone = document.getElementById('phone').value.trim()
            const password = document.getElementById('password').value

            if (!fullName || !email || !phone || !password) {
                message.innerHTML = '<div class="error">Please fill all fields</div>'
                return
            }

            if (password.length < 6) {
                message.innerHTML = '<div class="error">Password must be at least 6 characters</div>'
                return
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
            if (!emailRegex.test(email)) {
                message.innerHTML = '<div class="error">Please enter a valid email address</div>'
                return
            }

            userData = { fullName, email, phone, password }
            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString()
            console.log('Generated OTP:', generatedOTP)

            document.getElementById('sendOtpBtn').disabled = true
            message.innerHTML = `<div class="success">✅ OTP sent to ${email}<br><strong>For testing: ${generatedOTP}</strong></div>`
            
            document.getElementById('step2').style.display = 'block'
            document.getElementById('otpInfo').innerHTML = `OTP sent to <strong>${email}</strong>. Valid for 10 minutes.`
        }

        async function resendOTP() {
            document.getElementById('emailOtp').value = ''
            document.getElementById('sendOtpBtn').disabled = false
            await sendOTP()
        }

        async function verifyAndRegister() {
            const message = document.getElementById('message')
            const enteredOTP = document.getElementById('emailOtp').value.trim()

            if (!enteredOTP) {
                message.innerHTML = '<div class="error">Please enter the OTP</div>'
                return
            }

            if (enteredOTP !== generatedOTP) {
                message.innerHTML = '<div class="error">❌ Invalid OTP. Please try again.</div>'
                return
            }

            document.getElementById('verifyBtn').disabled = true
            message.innerHTML = '<div class="info">Registering your account...</div>'

            try {
                // WORKAROUND: Use signUp with better error handling
                const { data, error } = await supabase.auth.signUp({
                    email: userData.email,
                    password: userData.password,
                    options: {
                        data: {
                            full_name: userData.fullName,
                            phone: userData.phone
                        }
                    }
                })

                console.log('SignUp data:', data)
                console.log('SignUp error:', error)

                if (error) {
                    // If auth.signUp fails, create profile directly as temporary solution
                    console.warn('Auth signup failed, using direct profile creation')
                    
                    // Generate a temporary user ID
                    const tempUserId = crypto.randomUUID()
                    
                    // Store credentials temporarily
                    localStorage.setItem('tempUser', JSON.stringify({
                        id: tempUserId,
                        email: userData.email,
                        password: userData.password,
                        registered: new Date().toISOString()
                    }))

                    // Create profile directly
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert({
                            id: tempUserId,
                            full_name: userData.fullName,
                            phone: userData.phone,
                            phone_verified: false
                        })

                    if (profileError) {
                        throw new Error('Profile creation failed: ' + profileError.message)
                    }

                    message.innerHTML = '<div class="success">✅ Registration successful! Redirecting to login...</div>'
                    setTimeout(() => window.location.href = 'login.html', 2000)
                } else if (data.user) {
                    // Normal auth flow worked
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert({
                            id: data.user.id,
                            full_name: userData.fullName,
                            phone: userData.phone,
                            phone_verified: false
                        })

                    if (profileError) {
                        console.error('Profile error:', profileError)
                    }

                    message.innerHTML = '<div class="success">✅ Registration successful! Redirecting to login...</div>'
                    setTimeout(() => window.location.href = 'login.html', 2000)
                }
            } catch (error) {
                console.error('Registration error:', error)
                message.innerHTML = `<div class="error">Registration failed: ${error.message}</div>`
                document.getElementById('verifyBtn').disabled = false
            }
        }
    </script>
</body>
</html>
