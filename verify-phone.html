<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Phone - NoDealer</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f8f8f8; padding: 20px; }
        .container { max-width: 500px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #002f34; margin-bottom: 20px; }
        .info-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; }
        .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin-bottom: 20px; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 4px; margin: 10px 0; }
        label { display: block; margin: 15px 0 5px; font-weight: 500; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { width: 100%; padding: 14px; background: #002f34; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        button:hover { background: #003d47; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .resend { background: #6c757d; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Verify Your Phone Number</h1>
        
        <div class="info-box">
            <strong>⚠️ Phone Verification Required</strong>
            <p>Your account needs phone verification to be fully functional.</p>
            <p>Phone: <span id="phoneDisplay"></span></p>
        </div>

        <label for="phoneOtp">Enter 6-digit OTP</label>
        <input type="text" id="phoneOtp" placeholder="Enter OTP sent to your phone" maxlength="6">
        
        <button onclick="sendPhoneOTP()">Send OTP to Phone</button>
        <button onclick="verifyPhoneOTP()" class="resend">Verify OTP</button>
        
        <div id="message"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://vycimtexfyzlmlywjrzd.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ5Y2ltdGV4Znl6bG1seXdqcnpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4NDA5NTUsImV4cCI6MjA1MzQxNjk1NX0.qzW1U3Z8vKb1dBL4PHG_hGxwt8mKzL5tUOjl7ygDLJU'
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        let generatedOTP = ''
        let userId = ''
        let userPhone = ''

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession()
            if (!session) {
                window.location.href = 'login.html'
                return
            }
            userId = session.user.id
            await loadUserData()
        }

        async function loadUserData() {
            const { data, error } = await supabase
                .from('profiles')
                .select('phone, phone_verified')
                .eq('id', userId)
                .single()

            if (data) {
                userPhone = data.phone
                document.getElementById('phoneDisplay').textContent = userPhone
                
                if (data.phone_verified) {
                    document.querySelector('.info-box').innerHTML = '<div class="success-box"><strong>✅ Phone Already Verified</strong><p>Your phone number is verified!</p></div>'
                }
            }
        }

        async function sendPhoneOTP() {
            const message = document.getElementById('message')
            message.innerHTML = ''

            if (!userPhone) {
                message.innerHTML = '<div class="error">Phone number not found</div>'
                return
            }

            generatedOTP = Math.floor(100000 + Math.random() * 900000).toString()
            console.log('Generated Phone OTP:', generatedOTP)

            // In production: Send via SMS API (Twilio/MSG91/etc)
            message.innerHTML = `<div class="success">✅ OTP sent to ${userPhone}<br><strong>For testing: ${generatedOTP}</strong></div>`
        }

        async function verifyPhoneOTP() {
            const message = document.getElementById('message')
            const enteredOTP = document.getElementById('phoneOtp').value.trim()

            if (!enteredOTP) {
                message.innerHTML = '<div class="error">Please enter OTP</div>'
                return
            }

            if (enteredOTP !== generatedOTP) {
                message.innerHTML = '<div class="error">❌ Invalid OTP</div>'
                return
            }

            // Update database
            const { error } = await supabase
                .from('profiles')
                .update({ phone_verified: true })
                .eq('id', userId)

            if (error) {
                message.innerHTML = `<div class="error">Error: ${error.message}</div>`
                return
            }

            message.innerHTML = '<div class="success">✅ Phone verified successfully! Redirecting...</div>'
            setTimeout(() => window.location.href = 'index.html', 2000)
        }

        checkAuth()
    </script>
</body>
</html>
